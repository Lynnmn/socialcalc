<!DOCTYPE html>
<html>
<head>
    <title>训练计划数据报表</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/css/bootstrap.min.css">
    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
    <script src="./dist/jquery.calendar.js"></script>
    <script src="https://cdn.staticfile.org/popper.js/1.12.5/umd/popper.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/socialcalcconstants.js"></script>
    <script type="text/javascript" src="js/socialcalc-3.js"></script>
    <script type="text/javascript" src="js/socialcalctableeditor.js"></script>
    <script type="text/javascript" src="js/formatnumber2.js"></script>
    <script type="text/javascript" src="js/formula1.js"></script>
    <script type="text/javascript" src="js/socialcalcpopup.js"></script>
    <script type="text/javascript" src="js/socialcalcworkbook.js"></script>
    <script type="text/javascript" src="js/socialcalcactionbtns.js"></script>
    <link rel="stylesheet" type="text/css" href="css/socialcalc.css">
    <link rel="stylesheet" type="text/css" href="css/index.css">
    <link rel="stylesheet" type="text/css" href="css/reset.css">
</head>
<body>

<div class="container-fluid">
    <div class="first-part-actions" id="first-part-actions">
        <div class="btn-group btn-group-sm">
            <img class="icon-btn" src="./images/save.png" title="保存至服务器" data-toggle="modal" data-target="#modelSaveToServer" id="imgSave">
            <label class="input-file">
                <input type="file" name="inputFile" id="inputFile" value="" multiple="multiple"/>
                <img class="icon-btn" src="./images/input_file.png" title="选择文件" >
            </label>
            <img class="icon-btn" src="./images/import.png" title="导入远程文档" data-toggle="modal" data-target="#modelLoad" id="imgLoad">
            <img class="icon-btn" src="./images/share.png" title="分享链接" data-toggle="modal" data-target="#modelShareLink" id="show-share-link" >
    
            <div class="action-btns"></div>
            <a href="" download="a.txt" id="aSave">
                <img class="icon-btn" src="./images/download.png" title="下载excel文档">
            </a>
        </div>
        
        <div>
            <form class="form-inline">
                <label for="formula"><img src="./images/fx.png"></label>
                <input type="text" id="formula" placeholder="=A1+A2">
            </form>
        </div>
    </div>

 

    <div class="modal fade" id="modelLoad" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title" id="myModalLabel">
                        引用云端表格
                    </span>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <label>填写数据源: </label> <input type="text" id="inputRef" value="biz=personalize&table=训练计划创建情况&dateFrom=-1&dateTo=-10">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                    </button>
                    <button type="button" class="btn btn-primary" id="buttonLoad">
                        加载
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>

    <div class="modal fade" id="modelShareLink" tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title" id="myModalLabel1">
                        分享链接
                    </span>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                </div>
                <div class="modal-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>

    <div class="modal fade" id="modelSaveToServer" tabindex="-1" role="dialog" aria-labelledby="myModalLabel2" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title" id="myModalLabel2">
                        填写生成文件的文件名
                    </span>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <input placeholder="填写用户名" id="inputOwner"/>
                    <input placeholder="填写文件名" id="inputFileName"/>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="buttonSave">保存</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>


    <div>
        <div class="tab-content container-fluid" id="sheet"></div>
        <ul class="nav nav-tabs" id="nav-tabs" role="tablist">
            <!-- <li class="nav-item"></li> -->
            <li class="add-sheet" id="add-sheet-btn">
                <img src="./images/add-sheet.png" >
            </li>
        </ul>
    </div>
    <!-- div class="alert alert-success">
        指定操作成功提示信息。
    </div -->
</div>
<script>
    // var workbook = new SocialCalc.Workbook();
    // workbook.addNewSheet("sheet1");
    // workbook.selectSheet("sheet1", "sheet", "formula");
    let workbook = new SocialCalc.Workbook("sheet", "formula");
    let sheetIdMap = {};
    let config = {
        fileName: "",
        owner: "",
    };
    function generateSheetId () {
        let i = 1;
        while (true) {
            let name = "sheet" + i;
            if (!sheetIdMap[name]) {
                sheetIdMap[name] = 1;
                return name;
            }
            ++i;
        }
    }

    function addNewSheetTab (sheetInfo) {
        const sheetId = generateSheetId();
        if (!sheetInfo) {
            sheetInfo = workbook.addNewSheet();
        }
        const newLi = $('<li class="nav-item"><a class="nav-link" data-toggle="tab" href="#'+ sheetId +'" id="'+ sheetId +'">'+ sheetInfo.name +'</a></li>');
        $("#add-sheet-btn").before(newLi);
        addSheetTabMethod(sheetId);
    }

    $("#add-sheet-btn").click(function(e) {
        addNewSheetTab();
    });

    function addSheetTabMethod (sheetId) {
        let id = "#" + sheetId;
        $(id).dblclick(function () {
            const oldName = $(id).text();
            const newName = window.prompt("重命名sheet", oldName);
            if (newName && workbook.renameSheet(oldName, newName)) {
                $(id).text(newName);
            }
        });
        $(id).click(function () {
            const oldName = $(id).text();
            workbook.selectSheet(oldName);
        });
    }

    $(document).on('click', ".nav-item", function(){
        const id = $(this).children().attr("ID")
        workbook.selectSheet(id, "sheet", "formula");
    })

    $("#aSave").click(function (e) {
        let str = workbook.generateFile();
        alert(str);
        let fileStr = "data:text/plain;charset=utf-8," + str;
        $('#aSave').attr('href',fileStr);
    });
    $("#inputFile").change(function (e) {
        for (let i = 0; i < this.files.length; i++) {
            let file = this.files[i];
            console.log(file);
            let fr = new FileReader();
            fr.readAsText(file);
            fr.onload = function () {
                console.log(this.result);
                loadFileData(this.result);
            }
        }
    });
    function loadRemoteData (sheet, info) {
        if (sheet.remote && sheet.remote.length > 0) {
            // let ref = "biz=personalize&table=训练计划创建情况&dateFrom=20181030&dateTo=20181031";
            let url = "/api/stat?" + info.ref;
            $.get(url, function (jsonstr, status) {
                console.log(jsonstr);
                let data = JSON.parse(jsonstr);
                if (data.code != 0) {
                    alert("failed to load " + url);
                    return;
                }
                workbook.updateRemoteData(sheet, info, data.result);
            });
        }
    }
    $("#imgLoad").click(function () {
        let obj = document.getElementById("modelLoad");;
        SocialCalc.Keyboard.passThru = obj;
        obj.focus();
    });
    $("#imgSave").click(function () {
        let obj = document.getElementById("modelSaveToServer");;
        SocialCalc.Keyboard.passThru = obj;
        obj.focus();
    });
    $("#buttonLoad").click(function() {
        let ref = $("#inputRef").val();
        if (!workbook.editor.range.hasrange) {
            alert("please select a range");
            return;
        }
        let sheet = workbook.getCurrentSheet();
        let info = workbook.addRemoteInfo(sheet, ref);
        loadRemoteData(sheet, info);
        workbook.refresh();
    });
    function getValueFromQuery (name) {
        let reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
        let r = window.location.search.substr(1).match(reg);
        return r != null ? decodeURIComponent(r[2]) : null;
    }
    function loadFileData (fileData) {
        let list = JSON.parse(fileData);
        let first = true;
        for (let i = 0; i < list.length; ++i) {
            let info = list[i];
            let sheetInfo = workbook.addNewSheet(info.name, info.content, first);
            addNewSheetTab(sheetInfo);
            first = false;
            for (let j = 0; j < sheetInfo.sheet.remote.length; ++j) {
                loadRemoteData(sheetInfo.sheet, sheetInfo.sheet.remote[j]);
            }
        }
        if (!first) {
            workbook.refresh();
        }
    }
    $("#show-share-link").click(function () {
        let link = window.location.origin + window.location.pathname
            + "?fileName=" + config.fileName + "&owner=" + config.owner;
        $("#modelShareLink .modal-body").html(link)
    });
    $("#buttonSave").click(function () {
        let fileName = $("#inputFileName").val();
        let owner = $("#inputOwner").val();
        if (!fileName) {
            alert("please input file name");
            return;
        }
        if (!owner) {
            alert("please owner name");
            return;
        }
        let content = workbook.generateFile();
        $.post("/api/file", {
                fileName: fileName,
                owner: owner,
                content: content
            }, function(jsonstr) {
            console.log(jsonstr);
            let data = JSON.parse(jsonstr);
            if (data.code != 0) {
                alert("failed to load file: " + fileName + ", owner: " + owner);
                return;
            }
            alert("OK");
            config.fileName = fileName;
            config.owner = owner;
        });
    });
    $(document).ready(function() {
        $(".icon-btn").click(function () {
            const command = $(this).attr("command");
            const arg = $(this).attr("arg");
            workbook.executeCommand(command, arg);
        });
        let fileName = getValueFromQuery("fileName");
        let owner = getValueFromQuery("owner");
        if (!fileName || !owner) {
            addNewSheetTab();
            $("ul#nav-tabs").find("li:first-child").find("a").addClass("active show")
            return;
        }
        $.get("/api/file?fileName=" + fileName + "&owner=" + owner, function (jsonstr, status) {
            console.log(jsonstr);
            let data = JSON.parse(jsonstr);
            if (data.code != 0) {
                alert("failed to load " + url);
                return;
            }
            let content = data.result.content;
            loadFileData(content);
            $("#inputFileName").val(fileName);
            $("#inputOwner").val(owner);
            config.fileName = fileName;
            config.owner = owner;
        });
    });
    $(".select-time").showCalendar();

</script>
</body>
</html>