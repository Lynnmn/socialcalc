<!DOCTYPE html>
<html>
<head>
    <title>训练计划数据报表</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./dist/bootstrap.min.css">
    <script src="./dist/jquery.min.js"></script>
    <script src="./dist/jquery.calendar.js"></script>
    <script src="./dist/popper.min.js"></script>
    <script src="./dist/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/socialcalcconstants.js"></script>
    <script type="text/javascript" src="js/socialcalc-3.js"></script>
    <script type="text/javascript" src="js/socialcalctableeditor.js"></script>
    <script type="text/javascript" src="js/formatnumber2.js"></script>
    <script type="text/javascript" src="js/formula1.js"></script>
    <script type="text/javascript" src="js/socialcalcpopup.js"></script>
    <script type="text/javascript" src="js/socialcalcworkbook.js"></script>
    <script type="text/javascript" src="js/socialcalcactionbtns.js"></script>
    <link rel="stylesheet" type="text/css" href="css/socialcalc.css">
    <link rel="stylesheet" type="text/css" href="css/index.css">
    <link rel="stylesheet" type="text/css" href="css/reset.css">
</head>
<body>
<div class="container-fluid">
    <div class="first-part-actions" id="first-part-actions">
        <div class="btn-group btn-group-sm">
            <img class="icon-btn" src="./images/save.png" title="保存至服务器" data-toggle="modal" data-target="#modelSaveToServer" id="imgSave">
            <label class="input-file">
                <input type="file" name="inputLocalFile" id="inputLocalFile" value="" multiple="multiple"/>
                <img class="icon-btn" src="./images/input_file.png" title="选择文件" >
            </label>
            <img class="icon-btn" src="./images/import.png" title="导入远程文档" data-toggle="modal" data-target="#modelDataSource" id="imgLoad">
            <img class="icon-btn" src="./images/share.png" title="分享链接" data-toggle="modal" data-target="#modelShareLink" id="show-share-link" >
    
            <div class="action-btns"></div>
            <a href="" download="a.txt" id="aDownloadFile">
                <img class="icon-btn" src="./images/download.png" title="下载excel文档">
            </a>
        </div>
        
        <div>
            <form class="form-inline">
                <label for="formula"><img src="./images/fx.png"></label>
                <input type="text" id="formula" placeholder="=A1+A2">
            </form>
        </div>
    </div>
    <div class="modal fade" id="modelLoad" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title" id="myModalLabel">
                        引用云端表格
                    </span>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <label>填写数据源: </label> <input type="text" id="inputRef2" value="biz=personalize&table=训练计划创建情况&dateFrom=-1&dateTo=-10">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                    </button>
                    <button type="button" class="btn btn-primary" id="buttonLoad">
                        加载
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>

    <div class="modal fade" id="modelShareLink" tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title" id="myModalLabel1">
                        分享链接
                    </span>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                </div>
                <div class="modal-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>

    <div class="modal fade" id="modelSaveToServer" tabindex="-1" role="dialog" aria-labelledby="myModalLabel2" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title" id="myModalLabel2">
                        填写生成文件的文件名
                    </span>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <input placeholder="填写用户名" id="inputOwner"/>
                    <input placeholder="填写文件名" id="inputFileName"/>
                    <div>填写邮件信息</div>
                    <div>
                        <label>收件列表</label>
                        <input placeholder="收件人:aaa@qq.com,bbb@qq.com" id="inputTo" value="95813422@qq.com"/>
                    </div>
                    <div>
                        <label>抄送列表</label>
                        <input placeholder="抄送:aaa@qq.com,bbb@qq.com" id="inputCc"/>
                    </div>
                    <div>
                        <label>密送列表</label>
                        <input placeholder="密送:aaa@qq.com,bbb@qq.com" id="inputBcc"/>
                    </div>
                    <div>
                        <label>邮件标题</label>
                        <input placeholder="title:" id="inputTitle" value="test for outlook"/>
                    </div>
                    <div>
                        <label>开始时间</label>
                        <input type="datetime-local" id="inputDateTime" value="2018-11-01T15:00:00"/>
                    </div>
                    <div>
                        <label>每隔几天</label>
                        <input type="number" id="inputPeriod" value="1"/>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="buttonSendMail" data-dismiss="modal">发送</button>
                    <button type="button" class="btn btn-primary" id="buttonSaveFile">保存</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>

    <div class="modal fade" id="modelDataSource" tabindex="-1" role="dialog" aria-labelledby="myModalLabelDataSource" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title" id="myModalLabelDataSource">
                        管理数据源
                    </span>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-1">Sheet</div>
                        <div class="col-md-7">
                            <select id="selectSheet" class="form-control"></select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-1">Pos</div>
                        <div class="col-md-2">
                            <input placeholder="-1" type="number" id="inputPos"/>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-1">Range</div>
                        <div class="col-md-2">
                            <input placeholder="A1:B10" id="inputRange"/>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-1">Source</div>
                        <div class="col-md-11">
                            <input placeholder="k1=v1&k2=v2" id="inputRef"/>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-1"></div>
                        <div class="col-md-2">
                            <input type="button" class="btn-success" id="inputSetDataSource" value="save"/>
                        </div>
                    </div>
                    <br/>
                    <div style="overflow:scroll;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>range</th>
                                    <th>source</th>
                                    <th>edit</th>
                                </tr>
                            </thead>
                            <tbody id="dataSourceList">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>

    <div>
        <div class="tab-content container-fluid" id="sheet"></div>
        <ul class="nav nav-tabs" id="nav-tabs" role="tablist">
            <!-- <li class="nav-item"></li> -->
            <li class="add-sheet" id="add-sheet-btn">
                <img src="./images/add-sheet.png" >
            </li>
        </ul>
    </div>
    <!-- div class="alert alert-success">
        指定操作成功提示信息。
    </div -->
</div>
<script>
    Date.prototype.format = function(fmt) {
        var o = {
            "M+" : this.getMonth()+1,                 //月份
            "d+" : this.getDate(),                    //日
            "h+" : this.getHours(),                   //小时
            "m+" : this.getMinutes(),                 //分
            "s+" : this.getSeconds(),                 //秒
            "q+" : Math.floor((this.getMonth()+3)/3), //季度
            "S"  : this.getMilliseconds()             //毫秒
        };
        if(/(y+)/.test(fmt)) {
            fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length));
        }
        for(var k in o) {
            if(new RegExp("("+ k +")").test(fmt)){
                fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));
            }
        }
        return fmt;
    }

    let workbook = new SocialCalc.Workbook("sheet", "formula");
    let sheetIdMap = {};
    let config = {
        fileName: "",
        owner: "",
        today: "",
        mailInfo: {
            period: 1,
            startTime: new Date().getTime(),
        }
    };
    function generateSheetId () {
        let i = 1;
        while (true) {
            let name = "sheet" + i;
            if (!sheetIdMap[name]) {
                sheetIdMap[name] = 1;
                return name;
            }
            ++i;
        }
    }

    function addNewSheetTab (sheetInfo) {
        const sheetId = generateSheetId();
        if (!sheetInfo) {
            sheetInfo = workbook.addNewSheet();
        }
        const newLi = $('<li class="nav-item"><a class="nav-link" data-toggle="tab" href="#'+ sheetId +'" id="'+ sheetId +'">'+ sheetInfo.name +'</a></li>');
        $("#add-sheet-btn").before(newLi);
        addSheetTabMethod(sheetId);
    }

    $("#add-sheet-btn").click(function(e) {
        addNewSheetTab();
    });

    function addSheetTabMethod (sheetId) {
        let id = "#" + sheetId;
        $(id).dblclick(function () {
            const oldName = $(id).text();
            const newName = window.prompt("重命名sheet: " + oldName, oldName);
            if (newName && workbook.renameSheet(oldName, newName)) {
                $(id).text(newName);
            }
        });
        $(id).click(function () {
            const oldName = $(id).text();
            workbook.selectSheet(oldName);
        });
    }

    $(document).on('click', ".nav-item", function(){
        const id = $(this).children().attr("ID")
        workbook.selectSheet(id, "sheet", "formula");
    })

    $("#aDownloadFile").click(function (e) {
        let str = workbook.generateFile();
        alert(str);
        let fileStr = "data:text/plain;charset=utf-8," + str;
        $('#aDownloadFile').attr('download', config.fileName || "未命名文件");
        $('#aDownloadFile').attr('href',fileStr);
    });
    $("#inputLocalFile").change(function (e) {
        for (let i = 0; i < this.files.length; i++) {
            let file = this.files[i];
            let fr = new FileReader();
            fr.readAsText(file);
            fr.onload = function () {
                loadFileData(this.result, config.today);
            }
        }
    });
    function loadRemoteData (sheet, info, today) {
        if (sheet.remote && sheet.remote.length > 0) {
            let url = "/api/stat?" + info.ref;
            if (today) {
                url += "&today=" + today;
            }
            $.get(url, function (jsonstr, status) {
                let data = JSON.parse(jsonstr);
                if (data.code != 0) {
                    alert("failed to load " + url);
                    return;
                }
                workbook.updateRemoteData(sheet, info, data.result);
            });
        }
    }
    $("#imgLoad").click(function () {
        let selectHtml = "";
        for (let i = 0; i < workbook.sheetInfoList.length; ++i) {
            let sheetInfo = workbook.sheetInfoList[i];
            selectHtml += '<option value="' + sheetInfo.name + '">' + sheetInfo.name + '</option>';
        }
        $("#selectSheet").html(selectHtml);
        showDataSourceList(0);
        let obj = document.getElementById("modelLoad");
        SocialCalc.Keyboard.passThru = obj;
        obj.focus();
    });
    $("#selectSheet").change(function () {
        let sheetName = $("#selectSheet").val();
        let sheetIndex = workbook.getIndexBySheetName(sheetName);
        showDataSourceList(sheetIndex);
    });
    function showDataSourceList (sheetIndex) {
        let dataSourceHtml = "";
        if (workbook.sheetInfoList.length > sheetIndex) {
            let sheetInfo = workbook.sheetInfoList[sheetIndex];
            let remote = sheetInfo.sheet.remote;
            if (remote) {
                for (let j = 0; j < remote.length; ++j) {
                    let source = remote[j];
                    dataSourceHtml += '<tr><td>'
                        + source.coord1 + ':' + source.coord2 + '</td><td>'
                        + source.ref + '</td><td>'
                        + '<button class="btn btn-default" onclick="editDataSource(' + sheetIndex + ',' + j + ')">edit</button></td>'
                        + '<td><button class="btn btn-default" onclick="remoteDataSource(' + sheetIndex + ',' + j + ')">X</button></td></tr>';
                }
            }
        }
        $("#dataSourceList").html(dataSourceHtml);
    }
    function remoteDataSource (sheetIndex, index) {
        let sheetInfo = workbook.sheetInfoList[sheetIndex];
        if (!confirm('是否要刪除"' + sheetInfo.name + '"的一条数据源?')) {
            return;
        }
        let remote = sheetInfo.sheet.remote;
        if (remote.length > index) {
            remote.splice(index, 0);
        }
        let currentSheetName = $("#selectSheet").val();
        let newSheetIndex = workbook.getIndexBySheetName(currentSheetName);
        showDataSourceList(newSheetIndex);
    }
    function editDataSource (sheetIndex, index) {
        let sheetInfo = workbook.sheetInfoList[sheetIndex];
        let source = sheetInfo.sheet.remote[index];
        $("#inputRange").val(source.coord1 + ":" + source.coord2);
        $("#inputRef").val(source.ref);
        $("#inputPos").val(source.pos);
    }
    $("#inputSetDataSource").click(function () {
        let range = $("#inputRange").val();
        let ref = $("#inputRef").val();
        let pos = parseInt($("#inputPos").val());
        let ref = $("#inputRef").val();
        let cr2 = range.split(':');
        if (cr2.length != 2) {
            alert("range is invalid:" + range);
            return;
        }
        let sheetIndex = workbook.getIndexBySheetName($("#selectSheet").val());
        let sheet = workbook.sheetInfoList[sheetIndex].sheet;
        if (pos < 0 || pos >= sheet.remote.length) {
            let info = workbook.addRemoteInfo(sheet, ref);
            loadRemoteData(sheet, info, config.today);
            workbook.refresh();
        } else {

        }
        let info = workbook.addRemoteInfo(sheet, ref);
        loadRemoteData(sheet, info, config.today);
        workbook.refresh();
    });
    $("#imgSave").click(function () {
        $("#inputFileName").val(config.fileName);
        $("#inputOwner").val(config.owner);
        $("#inputTo").val(config.mailInfo.to);
        $("#inputCc").val(config.mailInfo.cc);
        $("#inputBcc").val( config.mailInfo.bcc);
        $("#inputTitle").val(config.mailInfo.title);
        if (!config.mailInfo.period) {
            $("#inputPeriod").val("0");
        } else {
            $("#inputPeriod").val(config.mailInfo.period);
        }
        let d = new Date();
        if (config.mailInfo.startTime) {
            d = new Date(config.mailInfo.startTime);
        }
        $("#inputDateTime").val(d.format("yyyy-MM-ddThh:mm:ss"));
        let obj = document.getElementById("modelSaveToServer");
        SocialCalc.Keyboard.passThru = obj;
        obj.focus();
    });
    $("#buttonSaveFile").click(function () {
        let fileName = $("#inputFileName").val();
        let owner = $("#inputOwner").val();
        if (!fileName) {
            alert("please input file name");
            return;
        }
        if (!owner) {
            alert("please owner name");
            return;
        }
        config.mailInfo.to = $("#inputTo").val();
        config.mailInfo.cc = $("#inputCc").val();
        config.mailInfo.bcc = $("#inputBcc").val();
        config.mailInfo.title = $("#inputTitle").val();
        config.mailInfo.startTime = new Date($("#inputDateTime").val()).getTime();
        config.mailInfo.period = $("#inputPeriod").val();
        let content = workbook.generateFile();
        $.post("/api/file", {
            fileName: fileName,
            owner: owner,
            content: content,
            mailInfo: JSON.stringify(config.mailInfo),
        }, function(jsonstr) {
            // console.log(jsonstr);
            let data = JSON.parse(jsonstr);
            if (data.code != 0) {
                alert("failed to load file: " + fileName + ", owner: " + owner);
                return;
            }
            alert("OK");
            config.fileName = fileName;
            config.owner = owner;
        });
    });
    $("#buttonSendMail").click(function () {
        let to = $("#inputTo").val();
        let cc = $("#inputCc").val();
        let bcc = $("#inputBcc").val();
        let title = $("#inputTitle").val();
        if (!title) {
            alert("请设置邮件标题");
            return;
        }
        if (!to && !cc && !bcc) {
            alert("请设置至少一个收件人");
            return;
        }
        let html = workbook.getHtmlForOutlook();
        sendMail(to, cc, bcc, title, html);
    });

    $("#buttonLoad").click(function() {
        let ref = $("#inputRef").val();
        if (!workbook.editor.range.hasrange) {
            alert("please select a range");
            return;
        }
        let sheet = workbook.getCurrentSheet();
        let info = workbook.addRemoteInfo(sheet, ref);
        loadRemoteData(sheet, info, config.today);
        workbook.refresh();
    });
    function getValueFromQuery (name) {
        let reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
        let r = window.location.search.substr(1).match(reg);
        return r != null ? decodeURIComponent(r[2]) : null;
    }
    function loadFileData (fileData, today) {
        let list = JSON.parse(fileData);
        let first = true;
        for (let i = 0; i < list.length; ++i) {
            let info = list[i];
            let sheetInfo = workbook.addNewSheet(info.name, info.content, first);
            addNewSheetTab(sheetInfo);
            first = false;
            for (let j = 0; j < sheetInfo.sheet.remote.length; ++j) {
                loadRemoteData(sheetInfo.sheet, sheetInfo.sheet.remote[j], today);
            }
        }
        if (!first) {
            workbook.refresh();
        }
    }
    $("#show-share-link").click(function () {
        let link = window.location.origin + window.location.pathname
            + "?fileName=" + config.fileName + "&owner=" + config.owner;
        $("#modelShareLink .modal-body").html(link)
    });

    function sendMail (to, cc, bcc, title, html) {
        if (!title) {
            alert("请设置邮件标题");
            return;
        }
        if (!to && !cc && !bcc) {
            alert("请设置至少一个收件人");
            return;
        }
        $.post("/api/mail", {
            title: title,
            to: to,
            cc: cc,
            bcc: bcc,
            body: html
        }, function(jsonstr) {
            console.log(jsonstr);
        });
    }
    function initFromUrlParam (fileName, owner, today, mail) {
        $.get("/api/file?fileName=" + fileName + "&owner=" + owner, function (jsonstr, status) {
            // console.log(jsonstr);
            let data = JSON.parse(jsonstr);
            if (data.code != 0) {
                alert("failed to load " + url);
                return;
            }
            config.fileName = fileName;
            config.owner = owner;
            if (today) {
                config.today = today;
            }
            if (data.result.mailInfo) {
                config.mailInfo = JSON.parse(data.result.mailInfo);
            }
            let content = data.result.content;
            loadFileData(content, today);
            if (mail) {
                let mailInfo = config.mailInfo;
                let html = workbook.getHtmlForOutlook();
                sendMail(mailInfo.to, mailInfo.cc, mailInfo.bcc, mailInfo.title, html);
            }
        });
    }
    $(document).ready(function () {
        $(".icon-btn").click(function () {
            let command = $(this).attr("command");
            let arg = $(this).attr("arg");
            if (command) {
                workbook.executeCommand(command, arg);
            }
        });
        $(window).resize(function () {
            workbook.resize();
        });
        let fileName = getValueFromQuery("fileName");
        let owner = getValueFromQuery("owner");
        let mail = getValueFromQuery("mail");
        let today = getValueFromQuery("today");
        if (!fileName || !owner) {
            addNewSheetTab();
            $("ul#nav-tabs").find("li:first-child").find("a").addClass("active show");
        } else {
            initFromUrlParam(fileName, owner, today, mail);
        }
    });
    $(".select-time").showCalendar();

</script>
</body>
</html>