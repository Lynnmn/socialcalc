<!DOCTYPE html>
<html>
<head>
    <title>数据报表</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./dist/bootstrap.min.css">
    <script src="./dist/jquery.min.js"></script>
    <script src="./dist/popper.min.js"></script>
    <script src="./dist/bootstrap.min.js"></script>
    <script type="text/javascript" src="dist/drag.1.0.js"></script>
    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script src="./dist/utils.js"></script>
    <script src="./dist/angular.min.js"></script>
    <script type="text/javascript" src="js/socialcalcconstants.js"></script>
    <script type="text/javascript" src="js/socialcalc-3.js"></script>
    <script type="text/javascript" src="js/socialcalctableeditor.js"></script>
    <script type="text/javascript" src="js/formatnumber2.js"></script>
    <script type="text/javascript" src="js/formula1.js"></script>
    <script type="text/javascript" src="js/socialcalcpopup.js"></script>
    <script type="text/javascript" src="js/socialcalcworkbook.js"></script>
    <script type="text/javascript" src="js/socialcalcactionbtns.js"></script>
    <script type="text/javascript" src="js/socialcalworkchart.js"></script>
    <link rel="stylesheet" type="text/css" href="css/socialcalc.css">
    <link rel="stylesheet" type="text/css" href="css/index.css">
    <link rel="stylesheet" type="text/css" href="css/reset.css">
</head>
<body ng-app="mainApp" ng-controller="mainController">
<div class="container-fluid">
    <div class="first-part-actions" id="first-part-actions">
        <div class="btn-group btn-group-sm">
            <a href="index.html" target="_blank">
                <img class="icon-btn" src="./images/create.png" title="新建项目">
            </a>
            <img class="icon-btn" src="./images/save.png" title="保存至服务器" data-toggle="modal" data-target="#modelSaveToServer" id="imgSave">
            <label class="input-file">
                <input type="file" onchange="angular.element(this).scope().loadLocalFile(this)" multiple="multiple"/>
                <img class="icon-btn" src="./images/input_file.png" title="选择文件" >
            </label>
            <img class="icon-btn" src="./images/import.png" title="导入远程文档" data-toggle="modal" data-target="#modelDataSource">
            <img class="icon-btn" src="./images/share.png" title="分享链接" data-toggle="modal" data-target="#modelShareLink" id="show-share-link" >
            <a ng-href="{{$.downloadModel.info.fileUri}}" ng-attr-download="{{$.downloadModel.info.fileName}}" ng-click="$.downloadModel.download()">
                <img class="icon-btn" src="./images/download.png" title="下载excel文档">
            </a>
            <img class="icon-btn" src="./images/mail.png" title="邮件设置" data-toggle="modal" data-target="#modelMail" id="imgMail" >
            <div class="action-btns"></div>
            <img class="icon-btn" src="./images/chart.png" title="插入图表" data-toggle="modal" data-target="#modelChart" id="modelChartIcon">
            <img class="icon-btn" src="./images/button_about.png" title="about" data-toggle="modal" data-target="#modelAbout">
        </div>
        
        <div>
            <form class="form-inline">
                <label for="formula"><img src="./images/fx.png"></label>
                <input type="text" id="formula" placeholder="=A1+A2">
            </form>
        </div>
    </div>
    <div class="modal fade" id="modelSaveToServer" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title">填写生成文件的文件名</span>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                </div>
                <div class="modal-body">
                    <input placeholder="填写用户名" ng-model="$.config.owner"/>
                    <input placeholder="填写文件名" ng-model="$.config.fileName"/>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" ng-click="$.saveModel.saveFile()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modelChart" tabindex="-1" role="dialog" aria-labelledby="modelChartLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title">
                        插入图表
                    </span>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <div class="chart-list" >
                        <img title="柱状图" name="bar" src="./images/bar.png" />
                        <img title="折线图" name="line" src="./images/brokenline.png" />
                        <img title="饼图" name="pie" src="./images/pie.png" />
                        <img title="区域图" name="area" src="./images/area.png" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="buttonSaveChart">确定</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modelMail" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title">邮件设置</span>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div>填写邮件信息</div>
                    <br/>
                    <div>
                        <label>收件列表</label>
                        <input placeholder="收件人:aaa@qq.com,bbb@qq.com" ng-model="$.config.mailInfo.to"/>
                    </div>
                    <div>
                        <label>抄送列表</label>
                        <input placeholder="抄送:aaa@qq.com,bbb@qq.com" ng-model="$.config.mailInfo.cc"/>
                    </div>
                    <div>
                        <label>密送列表</label>
                        <input placeholder="密送:aaa@qq.com,bbb@qq.com" ng-model="$.config.mailInfo.bcc"/>
                    </div>
                    <div>
                        <label>邮件标题</label>
                        <input placeholder="title:" ng-model="$.config.mailInfo.title"/>
                    </div>
                    <hr/>
                    <div>填写邮件章节信息</div>
                    <br/>
                    <div class="row" ng-repeat="m in $.config.mailInfo.chapterList">
                        <p class="col-1">{{$index+1}}.</p>
                        <p class="col-5">title: {{m.title}}</p>
                        <p class="col-5">sheet: {{m.sheetName}}</p>
                        <div class="col-1">
                            <button class="btn btn-primary btn-sm" ng-click="$.mailModel.deleteChapter($index)">X</button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-1"><p>选择</p></div>
                        <input class="col-5" ng-model="$.mailModel.selected.title" type="text"/>
                        <select class="col-5" ng-model="$.mailModel.selected.sheetName" ng-options="m.name for m in $.sheetInfoList"></select>
                        <div class="col-1"><button class="btn btn-default btn-sm" ng-click="$.mailModel.addChapter()">+</button></div>
                    </div>
                    <hr/>
                    <div>邮件调度信息</div>
                    <br/>
                    <div>
                        <label>开始时间</label>
                        <input type="datetime-local" ng-model="$.config.mailInfo.startTime" value="2018-11-01T15:00:00"/>
                    </div>
                    <div>
                        <label>每隔几天</label>
                        <input type="number" ng-model="$.config.mailInfo.period"/>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" ng-click="$.mailModel.send()" data-dismiss="modal">发送</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modelShareLink" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title">
                        分享链接
                    </span>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <a ng-href="{{$.shareModel.getUrl()}}">{{$.shareModel.getUrl()}}</a>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
    <div class="modal fade" id="modelDataSource" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title">
                        管理数据源
                    </span>
                    <button type="button" class="close" data-dismiss="modal">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-2">Sheet</div>
                        <div class="col-md-8">
                            <select class="form-control"
                                    ng-model="$.dataSourceModel.selected.sheetInfo"
                                    ng-options="m.name for m in $.sheetInfoList">
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-2">Pos</div>
                        <div class="col-md-2">
                            <input placeholder="-1" type="number" ng-model="$.dataSourceModel.selected.pos"/>
                        </div>
                        <div class="col-md-4">
                            <p>-1表示增加,否则为替换</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-2">Range</div>
                        <div class="col-md-2">
                            <input placeholder="A1:B10" ng-model="$.dataSourceModel.selected.range"/>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-2">Remote</div>
                        <div class="col-md-8">
                            <div>
                                <select class="form-control"
                                        ng-change="$.dataSourceModel.select(m)"
                                        ng-model="$.dataSourceModel.selected.source"
                                        ng-options="m.source as m.table for m in $.dataSourceModel.list">
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-2">Source</div>
                        <div class="col-md-10">
                            <input placeholder="k1=v1&k2=v2" ng-model="$.dataSourceModel.selected.ref"/>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-2"></div>
                        <div class="col-md-2">
                            <input type="button" class="btn-success" ng-click="$.dataSourceModel.add()" value="add"/>
                        </div>
                    </div>
                    <br/>
                    <div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>range</th>
                                    <th>source</th>
                                    <th>edit</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="item in $.dataSourceModel.selected.sheetInfo.sheet.remote">
                                    <td>{{item.coord1 + ":" + item.coord2}}</td>
                                    <td>{{item.ref}}</td>
                                    <td><button class="btn btn-default" ng-click="$.dataSourceModel.edit($index)">edit</button></td>
                                    <td><button class="btn btn-default" ng-click="$.dataSourceModel.remove($index)">X</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
    <div class="modal fade" id="modelAbout" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title">
                        About
                    </span>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <div>作者</div>
                    <hr/>
                    <div>
                        <a href="#">Dong</a>
                    </div>
                    <div>
                        <a href="#">SmartXiaoMing</a>
                    </div>
                    <br/>
                    <div>鸣谢</div>
                    <hr/>
                    <div>
                        <a href="http://www.iconfont.cn/">iconfont.cn</a>
                    </div>
                    <div>
                        <a href="https://www.highcharts.com/">highcharts</a>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>

    <div>
        <div class="tab-content container-fluid" id="sheet"></div>
        <ul class="nav nav-tabs" id="nav-tabs" role="tablist">
            <li class="nav-item" ng-repeat="sheetName in $.sheetTab.list">
                <a class="nav-link" data-toggle="tab" href="#"
                    ng-class="{active:$.sheetTab.isSelected($index)}"
                    ng-click="$.sheetTab.select($index)"
                    ng-dblclick="$.sheetTab.rename($index)">{{sheetName}}</a>
            </li>
            <li class="add-sheet" ng-click="$.sheetTab.add()">
                <img src="./images/add-sheet.png" >
            </li>
        </ul>
    </div>
   
    <div class="chart" id="chart">
        <img src="./images/delete.png" class="chart-delete" >
        <div id="chart-container"></div>
    </div>
   
    
</div>
<script>
let workbook = new SocialCalc.Workbook("sheet", "formula");
angular.module('mainApp', [])
.config(['$compileProvider', function($compileProvider) {
    $compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|tel|file|sms|data):/);
}])
.controller('mainController', function($scope, $http, $window) {
    let config = {
        fileName: "",
        owner: "",
        today: "",
        mailInfo: {
            period: 1,
            startTime: new Date(),
            title: "",
            chapterList: [], // {"title":"","sheetName":""},
            to: "",
            cc: "",
            bcc: "",
        }
    };

    let sheetTab = function () {
        let tabList = [];
        let selected = {
            index: 0
        };

        function select (index) {
            let name = tabList[index];
            selected.index = index;
            workbook.selectSheet(name);
        }

        function add (sheetName) {
            if (!sheetName) {
                let sheetInfo = workbook.addNewSheet();
                sheetName = sheetInfo.name;
                workbook.selectSheet(sheetName);
            }
            tabList.push(sheetName);
            workbook.selectSheet(sheetName);
            select(tabList.length - 1);
        }

        function rename (index) {
            let name = tabList[index];
            const newName = window.prompt("重命名sheet: " + name, name);
            if (newName && workbook.renameSheet(name, newName)) {
                tabList[index] = newName;
            }
        }

        function isSelected (index) {
            return selected.index == index;
        }

        function remove (index) {
            let name = tabList[index];
            workbook.removeSheet(name);
            tabList.splice(index, 1);
                list.push(response.data.result);
            if (tabList.length == 0) {
                selected.index = -1;
            } else if (selected.index >= tabList.length) {
                selected.index = tabList.length - 1;
            }
        }

        return {
            list: tabList,
            selected: selected,
            add: add,
            rename: rename,
            select: select,
            remove: remove,
            isSelected: isSelected,
        }
    }();

    let saveModel = function() {
        function saveFile() {
            if (!config.fileName) {
                alert("please input file name");
                return;
            }
            if (!config.owner) {
                alert("please owner name");
                return;
            }
            let content = workbook.generateFile();
            $http({
                method: 'POST',
                url: "/api/file",
                data: {
                    fileName: config.fileName,
                    owner: config.owner,
                    content: config.content,
                    mailInfo: JSON.stringify(config.mailInfo),
                },
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                transformRequest: transformRequest
            }).then(function (response) {
                if (response.data.code == 0) {
                    alert("OK");
                    document.title = fileName;
                } else {
                    console.log(response);
                    alert(response.data.message);
                }
            }, function (response) {
                alert("error: " + response);
            });
        }

        return {
            saveFile: saveFile,
        };
    }();

    let mailModel = function() {
        let selected = {
            title: "",
            sheetName: "",
        }

        function addChapter () {
            if (!selected.title) {
                alert('请设置章节标题');
                return;
            }
            if (!selected.sheetName) {
                alert('请设置章节对应表单');
                return;
            }
            let chapter = {
                title: selected.title,
                sheetName: selected.sheetName,
            };
            config.mailInfo.chapterList.push(chapter);
        }

        function deleteChapter (index) {
            config.mailInfo.chapterList.split(index, 1);
        }

        function send () {
            if (!config.mailInfo.title) {
                alert("请设置邮件标题");
                return;
            }
            if (!config.mailInfo.to && !config.mailInfo.cc && !config.mailInfo.bcc) {
                alert("请设置至少一个收件人");
                return;
            }
            let html = workbook.getHtmlForOutlook(config.mailInfo.chapterList);
            $http({
                method: 'POST',
                url: "/api/mail",
                data: {
                    title: config.mailInfo.title,
                    to: config.mailInfo.to,
                    cc: config.mailInfo.cc,
                    bcc: config.mailInfo.bcc,
                    body: html
                },
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                transformRequest: transformRequest,
            }).then(function (response) {
                if (response.data.code == 0) {
                    alert("OK");
                } else {
                    console.log(response);
                    alert(response.data.message);
                }
            }, function (response) {
                alert("error: " + response);
            });
        }

        return {
            selected: selected,
            send: send,
            addChapter: addChapter,
            deleteChapter: deleteChapter
        }
    }();

    let dataSourceModel = function() {
        let list = [];
        let selected = {
            sheetInfo: {},
            pos: -1,
            range: "",
            ref:"",
            source: "",
        }

        function initList () {
            let url = "/api/stat/table/info?offset=0&size=100";
            $http({
                method: 'GET',
                url: url,
            }).then(function (response) {
                if (response.data.code != 0) {
                    console.log(response);
                    alert(response.data.message);
                    return;
                }
                Object.assign(list, response.data.result);
            }, function (response) {
                console.log("error: " + response);
            });
        }

        function select () {
            selected.ref = selected.source;
        }

        async function add () {
            let cr2 = selected.range.split(':');
            if (cr2.length != 2) {
                alert("range is invalid:" + selected.range);
                return;
            }
            let sheet = selected.sheetInfo.sheet;
            let info = workbook.addRemoteInfo(sheet, cr2[0], cr2[1], selected.ref, selected.pos);
            await dataModel.loadRemoteData(sheet, info, config.today);
            workbook.refresh();
        }

        function edit (index) {
            let item = selected.sheetInfo.sheet.remote[index];
            selected.pos = index;
            selected.range = item.range,
            selected.ref = item.ref;
        }

        function remove (index) {
            if (!confirm('是否要刪除"' + selected.sheetInfo.name + '"的一条数据源?')) {
                return;
            }
            selected.sheetInfo.sheet.remote.splice(index, 1);
        }

        return {
            list: list,
            selected: selected,
            initList: initList,
            select: select,
            add: add,
            edit: edit,
            remove: remove
        }
    }();

    let downloadModel = (function() {
        let info = {
            fileName: "",
            fileUri: "",
        }

        function download () {
            info.fileName = config.fileName || "未命名文件";
            let str = workbook.generateFile();
            info.fileUri = "data:text/plain;charset=utf-8," + str;
        }

        return {
            info: info,
            download: download,
        }
    })();

    let shareModel = function () {
        function getUrl() {
            return window.location.origin + window.location.pathname
                + "?fileName=" + config.fileName + "&owner=" + config.owner;
        }

        return {
            getUrl: getUrl,
        }
    }();

    let dataModel = function () {
        async function loadRemoteData (sheet, info, today) {
            if (sheet.remote.length == 0) {
                return;
            }
            let url = "/api/stat?" + info.ref;
            if (today) {
                url += "&today=" + today;
            }
            await new Promise(function (resolve, reject) {
                $http({method: 'GET', url: url}).then(async function (response) {
                    if (response.data.code != 0) {
                        console.log("error: " + response);
                        alert("failed to load remote data:" + url);
                    }
                    workbook.updateRemoteData(sheet, info, response.data.result);
                    resolve();
                }, async function () {
                    console.log("error: " + response);
                    reject();
                });
            });
        }

        async function loadFileData (fileData, today) {
            let list = JSON.parse(fileData);
            for (let i = 0; i < list.length; ++i) {
                let info = list[i];
                let sheetInfo = workbook.addNewSheet(info.name, info.content);
                sheetTab.add(sheetInfo.name);
                for (let j = 0; j < sheetInfo.sheet.remote.length; ++j) {
                    await loadRemoteData(sheetInfo.sheet, sheetInfo.sheet.remote[j], today);
                }
            }
            workbook.recalcAllSheet();
            workbook.refresh();
        }

        function initFromUrlParam () {
            let fileName = getValueFromQuery("fileName");
            let owner = getValueFromQuery("owner");
            let mail = getValueFromQuery("mail");
            let today = getValueFromQuery("today");
            if (!fileName || !owner) {
                sheetTab.add();
                return;
            }
            let url = "/api/file?fileName=" + fileName + "&owner=" + owner;
            $http({method: 'GET', url: url}).then(async function (response) {
                 if (response.data.code != 0) {
                    console.log(response);
                    alert(response.data.message);
                    return;
                }
                let data = response.data;
                config.fileName = fileName;
                config.owner = owner;
                document.title = fileName;
                if (today) {
                    config.today = today;
                }
                if (data.result.mailInfo) {
                    config.mailInfo = JSON.parse(data.result.mailInfo);
                    if (typeof config.mailInfo.startTime === "number") {
                        config.mailInfo.startTime = new Date(config.mailInfo.startTime);
                    }
                    if (typeof config.mailInfo.period !== "number") {
                        config.mailInfo.period = parseInt(config.mailInfo.period);
                    }
                }
                let content = data.result.content;
                await loadFileData(content, today);
                if (mail) {
                    window.setTimeout(function () {
                        mailModel.send();
                    }, 1000); // give 1 second for recalc the formula data
                }
            }, function (response) {
                console.log("error: " + response);
            });
        }

        return {
            loadRemoteData: loadRemoteData,
            loadFileData: loadFileData,
            initFromUrlParam: initFromUrlParam,
        }
    }();

    function getCurrentSheet() {
        return workbook.getCurrentSheet();
    }

    $scope.$ = (function () {
        return {
            config: config,
            sheetInfoList: workbook.sheetInfoList,
            getCurrentSheet: getCurrentSheet,
            mailModel: mailModel,
            sheetTab: sheetTab,
            saveModel: saveModel,
            dataSourceModel: dataSourceModel,
            downloadModel: downloadModel,
            shareModel: shareModel,
            dataModel:dataModel,
        }
    })();

    angular.element($window).bind("resize", function () {
        workbook.resize();
    });

    dataModel.initFromUrlParam();
    dataSourceModel.initList();
});

$(document).ready(function () {
    $(".icon-btn").click(function () {
        let command = $(this).attr("command");
        let arg = $(this).attr("arg");
        if (command) {
            workbook.executeCommand(command, arg);
        }
    });
});

</script>
</body>
</html>